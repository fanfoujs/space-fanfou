SF.pl.emoji_selector = new SF.plugin((function($) {
  var $location_btn_wrapper = $('.location-button-wrapper');
  if (!$location_btn_wrapper.length) return;

  var textarea = $('#phupdate textarea')[0];

  var $emoji_btn_wrapper = $('<div />');
  $emoji_btn_wrapper.prop('className', 'emoji-button-wrapper');
  $emoji_btn_wrapper.click(function(e) {
    e.stopPropagation();
  });

  var $emoji_btn = $('<div />');
  $emoji_btn.prop('id', 'emoji-button');
  $emoji_btn.prop('title', '\u6dfb\u52a0 Emoji \u8868\u60c5');
  $emoji_btn.click(function(e) {
    $emoji_selector.toggle();
    showCategory('äººç‰©', 1);
  });
  $emoji_btn.appendTo($emoji_btn_wrapper);

  var $emoji_selector = $('<div />');
  $emoji_selector.prop('id', 'emoji-selector');
  $emoji_selector.appendTo($emoji_btn_wrapper);

  var emojis = {
    'äººç‰©': ["ğŸ˜„","ğŸ˜ƒ","ğŸ˜Š","â˜º","ğŸ˜","ğŸ˜","ğŸ˜˜","ğŸ˜š","ğŸ˜œ","ğŸ˜","ğŸ˜³","ğŸ˜","ğŸ˜Œ","ğŸ˜”","ğŸ˜’","ğŸ˜","ğŸ˜£","ğŸ˜¥","ğŸ˜‚","ğŸ˜­","ğŸ˜ª","ğŸ˜¢","ğŸ˜°","ğŸ˜…","ğŸ˜“","ğŸ˜©","ğŸ˜«","ğŸ˜¨","ğŸ˜±","ğŸ˜ ","ğŸ˜¡","ğŸ˜¤","ğŸ˜–","ğŸ˜†","ğŸ˜‹","ğŸ˜·","ğŸ˜","ğŸ˜µ","ğŸ˜²","ğŸ‘¿","ğŸ˜‰","ğŸ‘²","ğŸ‘³","ğŸ‘®","ğŸ‘·","ğŸ’‚","ğŸ‘¶","ğŸ‘¦","ğŸ‘§","ğŸ‘¨","ğŸ‘©","ğŸ‘´","ğŸ‘µ","ğŸ‘±","ğŸ‘¼","ğŸ‘¸","ğŸ˜º","ğŸ˜¸","ğŸ˜»","ğŸ˜½","ğŸ˜¼","ğŸ™€","ğŸ˜¿","ğŸ˜¹","ğŸ˜¾","ğŸ‘¹","ğŸ‘º","ğŸ™ˆ","ğŸ™‰","ğŸ™Š","ğŸ’€","ğŸ‘½","ğŸ’©","ğŸ”¥","âœ¨","ğŸŒŸ","ğŸ’«","ğŸ’¥","ğŸ’¢","ğŸ’¦","ğŸ’§","ğŸ’¤","ğŸ’¨","ğŸ‘‚","ğŸ‘€","ğŸ‘ƒ","ğŸ‘…","ğŸ‘„","ğŸ‘","ğŸ‘","ğŸ‘Œ","ğŸ‘Š","âœŠ","âœŒ","ğŸ‘‹","âœ‹","ğŸ‘","ğŸ‘†","ğŸ‘‡","ğŸ‘‰","ğŸ‘ˆ","ğŸ™Œ","ğŸ™","â˜","ğŸ‘","ğŸ’ª","ğŸš¶","ğŸƒ","ğŸ’ƒ","ğŸ‘«","ğŸ‘ª","ğŸ‘¬","ğŸ‘­","ğŸ’","ğŸ’‘","ğŸ‘¯","ğŸ™†","ğŸ™…","ğŸ’","ğŸ™‹","ğŸ’†","ğŸ’‡","ğŸ’…","ğŸ‘°","ğŸ™","ğŸ™","ğŸ™‡","ğŸ‘‘","ğŸ‘’","ğŸ‘Ÿ","ğŸ‘","ğŸ‘¡","ğŸ‘ ","ğŸ‘¢","ğŸ‘•","ğŸ‘”","ğŸ‘š","ğŸ‘—","ğŸ½","ğŸ‘–","ğŸ‘˜","ğŸ‘™","ğŸ’¼","ğŸ‘œ","ğŸ‘","ğŸ‘›","ğŸ‘“","ğŸ€","ğŸŒ‚","ğŸ’„","ğŸ’›","ğŸ’™","ğŸ’œ","ğŸ’š","â¤","ğŸ’”","ğŸ’—","ğŸ’“","ğŸ’•","ğŸ’–","ğŸ’","ğŸ’˜","ğŸ’Œ","ğŸ’‹","ğŸ’","ğŸ’","ğŸ‘¤","ğŸ’¬","ğŸ‘£"],
    'å¤§è‡ªç„¶': ["ğŸ¶","ğŸº","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¸","ğŸ¯","ğŸ¨","ğŸ»","ğŸ·","ğŸ½","ğŸ®","ğŸ—","ğŸµ","ğŸ’","ğŸ´","ğŸ‘","ğŸ˜","ğŸ¼","ğŸ§","ğŸ¦","ğŸ¤","ğŸ¥","ğŸ£","ğŸ”","ğŸ","ğŸ¢","ğŸ›","ğŸ","ğŸœ","ğŸ","ğŸŒ","ğŸ™","ğŸš","ğŸ ","ğŸŸ","ğŸ¬","ğŸ³","ğŸ«","ğŸ©","ğŸ¾","ğŸ²","ğŸŒ¸","ğŸŒ·","ğŸ€","ğŸŒ¹","ğŸŒ»","ğŸŒº","ğŸ","ğŸƒ","ğŸ‚","ğŸŒ¿","ğŸŒ¾","ğŸ„","ğŸŒµ","ğŸŒ´","ğŸŒ²","ğŸŒ³","ğŸŒ°","ğŸŒ±","ğŸŒ¼","ğŸŒ‘","ğŸŒ“","ğŸŒ”","ğŸŒ•","ğŸŒ›","ğŸŒ™","â˜€","ğŸŒ","ğŸŒ‹","ğŸŒŒ","ğŸŒƒ","â›…","âš¡","â˜”","â„","â›„","ğŸŒ€","ğŸŒ","ğŸŒˆ","ğŸŒŠ"],
    'ç‰©ä½“': ["â˜","ğŸ’","ğŸ","ğŸ’","ğŸ“","ğŸ","ğŸ†","ğŸ‡","ğŸ","ğŸ‘","ğŸƒ","ğŸ‘»","ğŸ…","ğŸ„","ğŸ","ğŸ‹","ğŸ‰","ğŸŠ","ğŸˆ","ğŸŒ","ğŸ”®","ğŸ¥","ğŸ“·","ğŸ“¹","ğŸ“¼","ğŸ’¿","ğŸ“€","ğŸ’½","ğŸ’¾","ğŸ’»","ğŸ“±","â˜","ğŸ“","ğŸ“Ÿ","ğŸ“ ","ğŸ“¡","ğŸ“º","ğŸ“»","ğŸ“¢","ğŸ“£","â³","âŒ›","â°","âŒš","ğŸ”“","ğŸ”’","ğŸ”","ğŸ”","ğŸ”‘","ğŸ”","ğŸ’¡","ğŸ”¦","ğŸ”Œ","ğŸ”‹","ğŸ”","ğŸ›€","ğŸš½","ğŸ”§","ğŸ”©","ğŸšª","ğŸš¬","ğŸ’£","ğŸ”«","ğŸ”ª","ğŸ’Š","ğŸ’‰","ğŸ’°","ğŸ’´","ğŸ’µ","ğŸ’³","ğŸ’¸","ğŸ“²","ğŸ“§","ğŸ“¥","ğŸ“¤","âœ‰","ğŸ“©","ğŸ“¨","ğŸ“«","ğŸ“ª","ğŸ“®","ğŸ“¦","ğŸ“","ğŸ“„","ğŸ“ƒ","ğŸ“‘","ğŸ“Š","ğŸ“ˆ","ğŸ“‰","ğŸ“œ","ğŸ“‹","ğŸ“…","ğŸ“†","ğŸ“‡","ğŸ“","ğŸ“‚","âœ‚","ğŸ“Œ","ğŸ“","âœ’","âœ","ğŸ“","ğŸ“","ğŸ“•","ğŸ“—","ğŸ“˜","ğŸ“™","ğŸ““","ğŸ“”","ğŸ“’","ğŸ“š","ğŸ“–","ğŸ”–","ğŸ“›","ğŸ“°","ğŸ¨","ğŸ¬","ğŸ¤","ğŸ§","ğŸ¼","ğŸµ","ğŸ¶","ğŸ¹","ğŸ»","ğŸº","ğŸ·","ğŸ¸","ğŸ‘¾","ğŸ®","ğŸƒ","ğŸ´","ğŸ€„","ğŸ²","ğŸ¯","ğŸˆ","ğŸ€","âš½","âš¾","ğŸ¾","ğŸ±","ğŸ³","â›³","ğŸ","ğŸ†","ğŸ¿","ğŸ‚","ğŸŠ","ğŸ„","ğŸ£","â˜•","ğŸµ","ğŸ¶","ğŸº","ğŸ»","ğŸ¸","ğŸ¹","ğŸ·","ğŸ´","ğŸ•","ğŸ”","ğŸŸ","ğŸ—","ğŸ–","ğŸ","ğŸ›","ğŸ¤","ğŸ±","ğŸ£","ğŸ¥","ğŸ™","ğŸ˜","ğŸš","ğŸœ","ğŸ²","ğŸ¢","ğŸ¡","ğŸ³","ğŸ","ğŸ©","ğŸ®","ğŸ¦","ğŸ¨","ğŸ§","ğŸ‚","ğŸ°","ğŸª","ğŸ«","ğŸ¬","ğŸ­","ğŸ¯","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸ’","ğŸ‡","ğŸ‰","ğŸ“","ğŸ‘","ğŸˆ","ğŸŒ","ğŸ","ğŸ†","ğŸ…","ğŸŒ½"],
    'åœ°ç‚¹': ["ğŸ ","ğŸ¡","ğŸ«","ğŸ¢","ğŸ£","ğŸ¥","ğŸ¦","ğŸª","ğŸ©","ğŸ¨","â›ª","ğŸ¬","ğŸŒ‡","ğŸŒ†","ğŸ¯","ğŸ°","ğŸ­","ğŸ—¼","ğŸ—¾","ğŸ—»","ğŸŒ„","ğŸŒ…","â›º","ğŸ—½","ğŸŒ‰","ğŸ ","ğŸ¡","â›²","ğŸ¢","ğŸš¢","â›µ","ğŸš¤","âš“","ğŸš€","âœˆ","ğŸ’º","ğŸš‰","ğŸš…","ğŸš„","ğŸšƒ","ğŸšŒ","ğŸš™","ğŸš—","ğŸš•","ğŸšš","ğŸš¨","ğŸš“","ğŸš’","ğŸš‘","ğŸš²","ğŸ’ˆ","ğŸš","ğŸ«","ğŸš¥","âš ","ğŸš§","ğŸ”°","â›½","ğŸ®","ğŸ°","â™¨","ğŸ—¿","ğŸª","ğŸ­","ğŸ“","ğŸš©","ğŸ‡¯ğŸ‡µ","ğŸ‡°ğŸ‡·","ğŸ‡©ğŸ‡ª","ğŸ‡¨ğŸ‡³","ğŸ‡ºğŸ‡¸","ğŸ‡«ğŸ‡·","ğŸ‡ªğŸ‡¸","ğŸ‡®ğŸ‡¹","ğŸ‡·ğŸ‡º","ğŸ‡¬ğŸ‡§"],
    'ç¬¦å·': ["1âƒ£","2âƒ£","3âƒ£","4âƒ£","5âƒ£","6âƒ£","7âƒ£","8âƒ£","9âƒ£","0âƒ£","ğŸ”Ÿ","ğŸ”¢","ğŸ˜€","ğŸ”£","â¬†","â¬‡","â¬…","â¡","ğŸ” ","ğŸ”¡","ğŸ”¤","â†—","â†–","â†˜","â†™","â†”","â†•","â—€","â–¶","ğŸ”¼","ğŸ”½","â†©","â†ª","â„¹","âª","â©","â«","â¬","â¤µ","â¤´","ğŸ†—","ğŸ†•","ğŸ†™","ğŸ†’","ğŸ†“","ğŸ†–","ğŸ“¶","ğŸ¦","ğŸˆ","ğŸš»","#âƒ£","ğŸ”","ğŸˆ¯","ğŸˆ³","ğŸˆµ","ğŸˆ´","ğŸˆ²","ğŸ‰","ğŸˆ¹","ğŸˆº","ğŸˆ¶","ğŸˆš","ğŸˆ·","ğŸˆ¸","ãŠ™","ãŠ—","ğŸ‰‘","ğŸˆ‚","â“‚","ğŸ…¿","ğŸš‡","ğŸš­","â™¿","ğŸš¾","ğŸš¹","ğŸšº","ğŸ†‘","ğŸ†˜","ğŸ†”","ğŸ†š","ğŸ“³","ğŸ“´","ğŸ’Ÿ","ğŸ…°","ğŸ…±","ğŸ†","ğŸ…¾","ğŸš¼","â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™","â™","â™","â™‘","â™’","â™“","â›","ğŸ”¯","ğŸ§","ğŸ’¹","âœ…","â","âœ³","â‡","âœ´","ğŸ’ ","ğŸ’²","ğŸ’±","Â©","Â®","â„¢","âŒ","â€¼","â‰","â—","â“","â•","â”","â­•","ğŸ”™","ğŸ”š","ğŸ”›","ğŸ”œ","ğŸ”ƒ","ğŸ•›","ğŸ••","ğŸ•’","ğŸ•˜","ğŸ•","ğŸ•‘","ğŸ•“","ğŸ•”","ğŸ•–","ğŸ•—","ğŸ•™","ğŸ•š","â•","â–","âœ–","â—","â™ ","â™¥","â™£","â™¦","ğŸ’®","ğŸ’¯","âœ”","â˜‘","ğŸ”˜","ğŸ”—","â°","ã€°","ã€½","ğŸ”±","â—¼","â—»","â—¾","â—½","â–ª","â–«","ğŸ”º","ğŸ”»","ğŸ”³","ğŸ”²","â¬›","â¬œ","âšª","âš«","ğŸ”´","ğŸ”µ","â­","ğŸ”¶","ğŸ”·","ğŸ”¸","ğŸ”¹"]
  };

  var categories = {
    'äººç‰©': 'people',
    'å¤§è‡ªç„¶': 'nature',
    'ç‰©ä½“': 'object',
    'åœ°ç‚¹': 'location',
    'ç¬¦å·': 'symbol'
  };

  function showCategory(cat, p) {
    $emoji_selector.html('');
    var $categories_wrapper = $('<div />');
    $categories_wrapper.addClass('categories-wrapper');

    var $categories = $('<ul />');
    $categories.addClass('categories');
    Object.keys(emojis).forEach(function(category) {
      $('<li />').append(
        $('<span />').addClass(categories[category]).
        toggleClass('current', cat === category).text(category)
      ).click(function() {
        showCategory($(this).text(), 1);
      })
      .toggleClass('current', cat === category).appendTo($categories);
    });
    $categories.appendTo($categories_wrapper);

    var $emoji_list = $('<ul />');
    $emoji_list.addClass('list');
    var emoji_list = emojis[cat].slice(60 * (p - 1), 60 * p);
    var html = emoji_list.map(function(e, i) {
      var in_last_line = parseInt(i / 12) >= parseInt((emoji_list.length - 1) / 12);
      var code = in_last_line ? ' class="last-line"' : '';
      return '<li' + code + '>' + e + '</li>';
    }).join('');
    if (emoji_list.length % 12 !== 0) {
      var i = emoji_list.length;
      while (i++ % 12) {
        html += '<li class="placeholder"></li>';
      }
    }
    $emoji_list.html(html);
    $('li.placeholder', $emoji_list).first().css({ height: '32px' });
    $emoji_list.on('click', 'li', function(e) {
      var emoji = e.target.textContent;
      insertText(emoji);
      $emoji_selector.hide();
      textarea.focus();
    });

    if (emojis[cat].length > 60) {
      var $emoji_paginator = $('<ul />');
      $emoji_paginator.addClass('paginator');
      var total_pages = Math.ceil(emojis[cat].length / 60);
      for (var i = 1; i <= total_pages; i++) (function(i) {
        var $page_number = $('<li />');
        $page_number.text(i);
        if (i === p) {
          $page_number.addClass('current');
        } else {
          $page_number.click(function(e) {
            showCategory(cat, i);
          });
        }
        $emoji_paginator.append($page_number);
      })(i);
    }

    $emoji_selector.append($categories_wrapper);
    $emoji_selector.append($emoji_list);
    $emoji_selector.append($emoji_paginator);
  }

  $('body').click(function() {
    $emoji_selector.hide();
  });

  function insertText(text) {
    var start = textarea.selectionStart,
      end = textarea.selectionEnd;
    textarea.value = textarea.value.substring(0, start) +
      text + textarea.value.substring(end, textarea.value.length);
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
  }

  return {
    load: function() {
      if ($location_btn_wrapper.length) {
        $('.upload-button-wrapper').before($emoji_btn_wrapper);
      }
    },
    unload: function() {
      $emoji_btn_wrapper.detach();
    }
  };
})(jQuery));
